#!/usr/bin/env python3

import os
from datetime import datetime
from datetime import timezone
import json
import re

htmlfilename = "/usr/local/var/www/alerts.html"
jsonfilename = "/usr/local/var/tcs/alerts.json"

htmlfile = open(htmlfilename, "w")

def readjson(filename):
    with open(filename, "r") as f:
        return json.loads(f.read(-1))

def writehtml(s):
    print(s, file=htmlfile)

def formattimestamp(timestamp):
    timestamp = re.sub("T", " ", timestamp)
    timestamp = re.sub("\.[0-9]*$", "", timestamp)
    return timestamp  
  
def formatage(eventtimestamp):
    eventtimestamp = re.sub("\.[0-9]*$", "", eventtimestamp)
    event = datetime.fromisoformat(eventtimestamp)
    now = datetime.now()
    age = now - event
    return "%.2f" % (age.days + age.seconds / 86400)
    

alerts = readjson(jsonfilename)

writehtml("""
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<link rel="stylesheet" href="style.css" type="text/css"/>
<title>Alerts</title>
</head>

<body>

<div id="title">
<h1>Alerts</h1>
<hr/>
</div>

<div id="body">
<table class="alerts">
""")

writehtml("<tr>")
for text in ["", "Name", "Event Time", "Age (days)", "α", "δ", "Epoch", "Uncertainty", "Priority", "Enabled", "Identifier"]:
  writehtml("<th class=\"alerts\">%s</th>" % text)
writehtml("</tr>")

alerts.sort(key=lambda x: x["eventtimestamp"], reverse=True)

for alert in alerts:
    print(alert["name"])
    writehtml("<tr>")
    writehtml("<td class=\"alerts\"><input type=\"radio\" name=\"id\" value=\"%s\"></td>" % alert["identifier"])
    for field in ["name", "eventtimestamp", "age", "alpha", "delta", "equinox", "uncertainty", "priority", "enabled", "identifier"]:
        writehtml("<td class=\"alerts\">")
        if field == "eventtimestamp":
            writehtml(formattimestamp(alert[field]))
        elif field == "age":
            writehtml(formatage(alert["eventtimestamp"]))
        else:
            writehtml(alert[field])
        writehtml("</td>")
    writehtml("</tr>")

writehtml("""
</table>

<hr/>

<p>NONE OF THE BUTTONS WORK YET!</p>

<p>A new page is created each minute, but you have to reload manually.</p>

<hr/>

<table>
<tr><td><button type="button">Enable</button></td></tr>
<tr><td><button type="button">Disable</button</td></tr>
</table>

<hr/>

<table>
<tr><td><button type="button">Update</button></td></tr>
<tr><td>α</td><td><input type="text" id="alert" name="alpha"></td></tr>
<tr><td>δ</td><td><input type="text" id="alert" name="delta"></td></tr>
<tr><td>Uncertainty</td><td><input type="text" id="alert" name="uncertainty"></td></tr>
<tr><td>Priority</td><td><input type="text" id="alert" name="priority"></td></tr>
</table>

<hr/>

<table>
<tr><td><button type="button">New</button></td></tr>
<tr><td>Name</td><td><input type="text" id="alert" name="name"></td></tr>
<tr><td>Event Time</td><td><input type="text" id="alert" name="eventtime"></td></tr>
<tr><td>α</td><td><input type="text" id="alert" name="alpha"></td></tr>
<tr><td>δ</td><td><input type="text" id="alert" name="delta"></td></tr>
<tr><td>Uncertainty</td><td><input type="text" id="alert" name="uncertainty"></td></tr>
<tr><td>Priority</td><td><input type="text" id="alert" name="priority"></td></tr>
</table>

</div>

<div>
<hr/>
Updated: %s UTC
</div>

</body>


</html>
""" % datetime.now(timezone.utc).replace(tzinfo=None).isoformat(" ", timespec="seconds"))
